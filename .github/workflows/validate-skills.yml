name: Validate Skills

on:
  push:
    paths:
      - '.claude/skills/**'
      - '.github/workflows/validate-skills.yml'
  pull_request:
    paths:
      - '.claude/skills/**'
  workflow_dispatch:
    inputs:
      full_validation:
        description: 'Run full validation including source checks'
        required: false
        default: 'false'
        type: boolean

jobs:
  validate-structure:
    name: Validate Skill Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install -g yaml js-yaml

      - name: Validate REGISTRY.yaml syntax
        run: |
          echo "Validating REGISTRY.yaml..."
          node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            try {
              const doc = yaml.load(fs.readFileSync('.claude/skills/REGISTRY.yaml', 'utf8'));
              console.log('✅ REGISTRY.yaml is valid YAML');

              // Check required sections
              const required = ['metadata', 'generic', 'skill_index'];
              for (const section of required) {
                if (!doc[section]) {
                  console.error('❌ Missing required section: ' + section);
                  process.exit(1);
                }
              }
              console.log('✅ All required sections present');
            } catch (e) {
              console.error('❌ Invalid YAML:', e.message);
              process.exit(1);
            }
          "

      - name: Validate skill files
        run: |
          echo "Validating skill markdown files..."

          # Find all skill files
          skill_files=$(find .claude/skills/generic .claude/skills/domain -name "*.md" 2>/dev/null || true)

          if [ -z "$skill_files" ]; then
            echo "⚠️ No skill files found"
            exit 0
          fi

          errors=0
          for file in $skill_files; do
            echo "Checking $file..."

            # Check for YAML frontmatter
            if ! head -1 "$file" | grep -q "^---$"; then
              echo "❌ $file: Missing YAML frontmatter"
              errors=$((errors + 1))
              continue
            fi

            # Extract and validate frontmatter
            frontmatter=$(sed -n '/^---$/,/^---$/p' "$file" | sed '1d;$d')

            # Check required fields
            for field in name version confidence sources; do
              if ! echo "$frontmatter" | grep -q "^$field:"; then
                echo "❌ $file: Missing required field '$field'"
                errors=$((errors + 1))
              fi
            done

            # Check for required sections
            for section in "## When to Use" "## Patterns" "## Anti-Patterns" "## Verification Checklist"; do
              if ! grep -q "$section" "$file"; then
                echo "⚠️ $file: Missing section '$section'"
              fi
            done

            echo "✅ $file: Structure valid"
          done

          if [ $errors -gt 0 ]; then
            echo "❌ Found $errors error(s)"
            exit 1
          fi

          echo "✅ All skill files valid"

  validate-registry-sync:
    name: Validate Registry Sync
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check registry matches files
        run: |
          echo "Checking registry matches actual files..."

          # Get skills from registry
          registry_skills=$(grep -E "^  [a-z]" .claude/skills/REGISTRY.yaml | grep -v "^  #" | sed 's/:$//' | tr -d ' ' || true)

          # Get actual skill files
          file_skills=$(find .claude/skills/generic .claude/skills/domain -name "*.md" -exec basename {} .md \; 2>/dev/null | sort || true)

          echo "Registry skills:"
          echo "$registry_skills" | sort
          echo ""
          echo "File skills:"
          echo "$file_skills"

          # Check for mismatches
          missing_files=""
          for skill in $registry_skills; do
            if ! echo "$file_skills" | grep -q "^$skill$"; then
              missing_files="$missing_files $skill"
            fi
          done

          if [ -n "$missing_files" ]; then
            echo "⚠️ Skills in registry but missing files:$missing_files"
          fi

          unregistered=""
          for skill in $file_skills; do
            if ! echo "$registry_skills" | grep -q "^$skill$"; then
              unregistered="$unregistered $skill"
            fi
          done

          if [ -n "$unregistered" ]; then
            echo "⚠️ Skill files not in registry:$unregistered"
          fi

          echo "✅ Registry sync check complete"

  count-tokens:
    name: Count Skill Tokens
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Estimate token counts
        run: |
          echo "Estimating token counts for skills..."
          echo ""
          echo "| Skill | Chars | ~Tokens | Status |"
          echo "|-------|-------|---------|--------|"

          total_tokens=0

          for file in $(find .claude/skills/generic .claude/skills/domain -name "*.md" 2>/dev/null | sort); do
            name=$(basename "$file" .md)
            chars=$(wc -c < "$file")
            tokens=$((chars / 4))  # ~4 chars per token
            total_tokens=$((total_tokens + tokens))

            if [ $tokens -gt 1500 ]; then
              status="❌ Over limit"
            elif [ $tokens -gt 1200 ]; then
              status="⚠️ Near limit"
            else
              status="✅ OK"
            fi

            echo "| $name | $chars | ~$tokens | $status |"
          done

          echo ""
          echo "**Total: ~$total_tokens tokens across all skills**"

          if [ $total_tokens -gt 50000 ]; then
            echo "⚠️ Warning: Total skill tokens exceeding 50k"
          fi

  # Optional: Run on schedule for periodic validation
  # scheduled-review:
  #   name: Scheduled Skill Review
  #   runs-on: ubuntu-latest
  #   if: github.event.schedule
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Check for skills needing review
  #       run: |
  #         echo "Checking for skills past review date..."
  #         # This would integrate with SKILL-VALIDATOR agent
